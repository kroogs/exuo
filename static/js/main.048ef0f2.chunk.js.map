{"version":3,"sources":["peer/PeerConnector.tsx","peer/index.ts","graph/useGraph.ts","graph/models/factories.ts","note/Note.ts","note/NoteEditor.tsx","graph/models/Node.ts","note/TitleBarNoteEditor.tsx","graph/models/Unknown.ts","graph/models/Config.ts","graph/models/Graph.ts","graph/views/NodeListItem.tsx","graph/views/EdgeList.tsx","graph/views/LabelEditor.tsx","select/SelectButton.tsx","graph/views/NodeActions.tsx","graph/views/NodeLayout.tsx","graph/views/NodeViewer.tsx","route.tsx","theme.tsx","index.tsx","common/Layout.tsx","common/TitleBar.tsx","common/Settings.tsx","common/utils.tsx","store/persist.ts","store/StoreProvider.tsx","store/views/PropertyEditor.tsx","store/models/Store.ts","store/useStore.ts"],"names":["PeerConnector","id","React","useState","peerError","setPeerError","hasAccepted","setHasAccepted","navigate","useNavigate","useGraph","graph","align","mt","textAlign","color","disabled","onClick","seekPeerConnection","then","instance","makeUrl","catch","error","size","selector","useStore","store","edgeMapFactory","getEdgeType","types","model","edgeMap","map","array","safeReference","late","acceptsUndefined","actions","self","hasEdge","tag","target","Boolean","get","includes","length","addEdge","has","set","push","removeEdge","remove","views","getEdgeTag","nodeFactory","models","compose","identifier","concat","named","graphFactory","nodeModels","options","Object","fromEntries","keys","key","isModelType","isIdentifierType","properties","Error","createNode","modelName","props","node","create","getId","uuid","put","NodeBase","Node","Note","label","string","summary","maybe","rawContentState","setLabel","setSummary","setRawContentState","value","JSON","stringify","BLOCK_TYPES","style","icon","INLINE_STYLES","styleMap","CODE","backgroundColor","fontFamily","fontSize","padding","getBlockStyle","block","getType","StyleButton","onToggle","active","onToggleWrap","e","preventDefault","className","IconButton","onMouseDown","Button","startIcon","undefined","BlockStyleControls","editorState","selection","getSelection","blockType","getCurrentContent","getBlockForKey","getStartKey","type","InlineStyleControls","currentStyle","getCurrentInlineStyle","useStyles","makeStyles","theme","createStyles","root","width","input","toolbar","forwardRef","ref","note","text","placeholder","onValue","autoFocus","classes","contentState","useMemo","convertFromRaw","parse","EditorState","createWithContent","ContentState","createFromText","setEditorState","handleValue","event","rawContent","convertToRaw","getFirstBlock","getText","join","blockStyleFn","customStyleMap","handleKeyCommand","command","newState","RichUtils","keyBindingFn","keyCode","shiftKey","getDefaultKeyBinding","onChange","onBlur","spellCheck","Toolbar","variant","Box","flexGrow","inlineStyle","toggleInlineStyle","toggleBlockType","palette","secondary","background","default","spacing","backButton","visibility","pointerEvents","hide","mouseEvents","settingsButton","title","overflowX","whiteSpace","textOverflow","primary","union","Config","optional","graphRoot","getParentOfType","Graph","getConfig","console","log","config","getSnapshot","toggleExpand","parentNode","expandedNodes","nodeIds","delete","isExpanded","Unknown","null","boolean","number","name","items","setActiveMode","mode","activeModes","unsetActiveMode","toggleActiveMode","clearSelectedNodes","toggleSelectNode","selectedNodes","clear","deleteSelectedNodes","forEach","nodeId","moveSelectedNodes","accessorId","accessor","cursorNode","copySelectedNodes","linkSelectedNodes","values","unlinkSelectedNodes","removeSelectedNodes","deleteNode","setCursorNode","afterCreate","persist","rootNode","applySnapshot","system","rootNodeId","createChild","edgeProps","edgeType","child","count","itemContainer","listItem","cursor","transition","transitions","duration","shortest","main","fade","borderTop","divider","childList","marginLeft","itemText","margin","display","paddingLeft","listItemSelectCheckbox","listItemIcon","minWidth","labelEditor","secondaryActions","right","childButton","paddingRight","NodeListItem","expandSecondaryTypography","expanded","isEditing","setIsEditing","isSelected","newlinePosition","indexOf","ListItem","altKey","metaKey","ctrlKey","selected","ContainerProps","childCount","ListItemText","slice","ListItemSecondaryAction","to","component","Link","endIcon","Collapse","in","timeout","unmountOnExit","edgeTag","defaultProps","list","borderBottom","EdgeList","outer","List","aria-label","item","typography","body1","LabelEditor","inputRef","useRef","inputValue","setInputValue","didRender","setDidRender","useEffect","current","setSelectionRange","ClickAwayListener","onClickAway","InputBase","fullWidth","multiline","onKeyDown","inputProps","position","buttonGroup","borderRight","selectCount","bottom","selectButton","deleteButton","popper","marginRight","paper","border","selectMenu","outline","SelectButton","extraProps","open","setOpen","anchorRef","selectedCount","selectedNodeCount","Popper","anchorEl","role","disablePortal","placement","Paper","elevation","MenuList","dense","MenuItem","justifyContent","breakpoints","up","insertButton","textShadow","boxShadow","backgroundBlendMode","emphasize","NodeActions","hasChildren","paddingBottom","appBar","backdropFilter","titleBar","children","zIndex","left","transform","NodeLayout","AppBar","NodeViewer","lookup","path","process","Route","Component","Router","basepath","Settings","ThemeProvider","prefersDarkMode","useMediaQuery","createMuiTheme","shape","borderRadius","MuiButton","disableElevation","MuiButtonGroup","overrides","MuiButtonBase","MuiCssBaseline","html","userSelect","overscrollBehavior","maxWidth","height","CssBaseline","ReactDOM","render","StrictMode","document","getElementById","Layout","TitleBar","showBackButton","showSettingsButton","isRootPath","edge","window","history","back","Typography","subheader","ListSubheader","ListItemIcon","Switch","checked","listCheckboxSetting","toggleListCheckboxSetting","location","pathname","a","db","Dexie","tableNames","getMembers","tableConfig","version","stores","Promise","all","table","toArray","rows","r","resolved","buffer","onPatch","patch","clearTimeout","setTimeout","split","typeName","propName","op","propValue","isStateTreeNode","update","setLocation","storeContext","createContext","StoreProvider","createElement","Provider","useContext","useObserver"],"mappings":"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","file":"static/js/main.048ef0f2.chunk.js","sourcesContent":["/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport { Box, Button, Typography, CircularProgress } from '@material-ui/core'\nimport { IAnyStateTreeNode } from 'mobx-state-tree'\nimport { useNavigate } from '@reach/router'\n\nimport { Layout } from 'common'\nimport { makeUrl } from 'route'\nimport { useGraph } from 'graph'\n\ninterface PeerConnectorProps {\n  id?: string\n}\n\nexport const PeerConnector: React.FunctionComponent<PeerConnectorProps> = ({\n  id,\n}) => {\n  const [peerError, setPeerError] = React.useState<null | Error>(null)\n  const [hasAccepted, setHasAccepted] = React.useState(false)\n  const navigate = useNavigate()\n\n  return useGraph(graph => {\n    const handleAccept: React.EventHandler<React.SyntheticEvent> = () => {\n      setHasAccepted(true)\n      graph\n        .seekPeerConnection(id)\n        .then((instance: IAnyStateTreeNode) => {\n          navigate(makeUrl(`/node/${instance.id}`))\n        })\n        .catch((error: Error) => {\n          setPeerError(error)\n        })\n    }\n\n    return (\n      <Layout>\n        <Typography align=\"center\">\n          Someone wants to share content with you.\n          <br />\n          Do not accept if you do not trust them.\n        </Typography>\n        <Box mt={1} textAlign=\"center\">\n          {peerError ? (\n            <Typography color=\"error\">{peerError}</Typography>\n          ) : (\n            <Button\n              disabled={hasAccepted}\n              onClick={handleAccept}\n              color=\"primary\"\n            >\n              {hasAccepted ? <CircularProgress size={24} /> : 'Accept'}\n            </Button>\n          )}\n        </Box>\n      </Layout>\n    )\n  })\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nexport * from './PeerConnector'\nexport * from './PeerManager'\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport { Instance } from 'mobx-state-tree'\n\nimport { useStore } from 'store'\n\nimport { Graph } from './models/Graph'\n\nexport const useGraph = <S>(selector: (s: Instance<typeof Graph>) => S): S =>\n  useStore(store => selector(store.graph))\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport {\n  IAnyModelType,\n  IAnyType,\n  Instance,\n  isIdentifierType,\n  SnapshotIn,\n  isModelType,\n  types,\n} from 'mobx-state-tree'\nimport { v4 as uuid } from 'uuid'\n\nexport type ModelOrUnion = IAnyModelType | IAnyType\nexport type EdgeResolver = () => ModelOrUnion\nexport type ModelTable = Record<string, IAnyModelType>\n\nexport const edgeMapFactory = (getEdgeType: EdgeResolver): IAnyModelType =>\n  types\n    .model('EdgeMap', {\n      edgeMap: types.map(\n        types.array(\n          types.safeReference(types.late(getEdgeType), {\n            acceptsUndefined: false,\n          }),\n        ),\n      ),\n    })\n    .actions(self => ({\n      hasEdge(tag: string, target?: Instance<IAnyModelType>): boolean {\n        if (target) {\n          return Boolean(self.edgeMap.get(tag)?.includes(target))\n        } else {\n          return Boolean(self.edgeMap.get(tag)?.length)\n        }\n      },\n    }))\n    .actions(self => ({\n      addEdge(tag: string, target: Instance<IAnyModelType>): void {\n        if (!self.edgeMap.has(tag)) {\n          self.edgeMap.set(tag, [])\n        }\n\n        self.edgeMap.get(tag)?.push(target)\n      },\n\n      removeEdge(tag: string, target: Instance<IAnyModelType>): void {\n        self.edgeMap.get(tag)?.remove(target)\n      },\n    }))\n    .views(self => ({\n      getEdgeTag(tag: string): void | Array<Instance<IAnyModelType>> {\n        return self.edgeMap.get(tag)\n      },\n    }))\n\nexport const nodeFactory = (\n  models: IAnyModelType | Array<IAnyModelType> = [],\n): IAnyModelType =>\n  types\n    .compose(\n      // @ts-ignore\n      ...[\n        types.model({\n          id: types.identifier,\n        }),\n      ].concat(models),\n    )\n    .named('Node')\n\ninterface GraphFactoryOptions {\n  getId?: () => string\n}\n\nexport const graphFactory = (\n  nodeModels: ModelTable,\n  options: GraphFactoryOptions = {},\n): IAnyModelType =>\n  types\n    .model(\n      'Graph',\n      Object.fromEntries(\n        Object.keys(nodeModels).map(key => {\n          const model = nodeModels[key]\n\n          if (isModelType(model) && isIdentifierType(model.properties.id)) {\n            return [key, types.map(nodeModels[key])]\n          }\n\n          // Can't add an identifier because the model may be referenced\n          throw Error(`Model '${key}' requires 'id' identifier`)\n        }),\n      ),\n    )\n    .actions(self => ({\n      createNode(\n        modelName = 'Node',\n        props: SnapshotIn<IAnyModelType> = {},\n      ): Instance<IAnyModelType> {\n        if (!nodeModels[modelName]) {\n          throw Error(`No model named '${modelName}'`)\n        }\n\n        const node = nodeModels[modelName].create({\n          id: options.getId?.() ?? uuid(),\n          ...props,\n        })\n\n        self[modelName].put(node)\n\n        return node\n      },\n    }))\n\nexport const NodeBase = nodeFactory(edgeMapFactory(() => NodeBase))\nexport const GraphBase = graphFactory({ Node: NodeBase })\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport { types } from 'mobx-state-tree'\nimport { convertToRaw } from 'draft-js'\n\nexport const Note = types\n  .model('Note', {\n    label: types.string,\n    summary: types.maybe(types.string),\n    rawContentState: types.maybe(types.string),\n  })\n  .actions(self => ({\n    setLabel(label: string) {\n      self.label = label\n    },\n\n    setSummary(summary: string) {\n      self.summary = summary\n    },\n\n    setRawContentState(value: ReturnType<typeof convertToRaw>) {\n      self.rawContentState = JSON.stringify(value)\n    },\n  }))\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport { Instance } from 'mobx-state-tree'\nimport {\n  Box,\n  Button,\n  IconButton,\n  Toolbar,\n  Theme,\n  makeStyles,\n  createStyles,\n} from '@material-ui/core'\nimport Code from '@material-ui/icons/Code'\nimport FormatQuote from '@material-ui/icons/FormatQuote'\nimport FormatBold from '@material-ui/icons/FormatBold'\nimport FormatItalic from '@material-ui/icons/FormatItalic'\nimport FormatUnderlined from '@material-ui/icons/FormatUnderlined'\nimport SpaceBar from '@material-ui/icons/SpaceBar'\nimport FormatListNumbered from '@material-ui/icons/FormatListNumbered'\nimport FormatListBulleted from '@material-ui/icons/FormatListBulleted'\nimport {\n  ContentBlock,\n  ContentState,\n  DraftEditorCommand,\n  DraftHandleValue,\n  Editor,\n  EditorState,\n  RichUtils,\n  getDefaultKeyBinding,\n  convertFromRaw,\n  convertToRaw,\n} from 'draft-js'\nimport 'draft-js/dist/Draft.css'\n\nimport { Note } from './Note'\n\ninterface ButtonConfig {\n  label: string\n  style: string\n  icon?: React.ReactElement\n}\n\nconst BLOCK_TYPES: Array<ButtonConfig> = [\n  /* { label: 'H1', style: 'header-one' }, */\n  /* { label: 'H2', style: 'header-two' }, */\n  /* { label: 'H3', style: 'header-three' }, */\n  /* { label: 'H4', style: 'header-four' }, */\n  /* { label: 'H5', style: 'header-five' }, */\n  /* { label: 'H6', style: 'header-six' }, */\n  { label: 'UL', style: 'unordered-list-item', icon: <FormatListNumbered /> },\n  { label: 'OL', style: 'ordered-list-item', icon: <FormatListBulleted /> },\n  { label: 'Blockquote', style: 'blockquote', icon: <FormatQuote /> },\n  { label: 'Code Block', style: 'code-block', icon: <Code /> },\n]\n\nconst INLINE_STYLES: Array<ButtonConfig> = [\n  { label: 'Bold', style: 'BOLD', icon: <FormatBold /> },\n  { label: 'Italic', style: 'ITALIC', icon: <FormatItalic /> },\n  { label: 'Underline', style: 'UNDERLINE', icon: <FormatUnderlined /> },\n  { label: 'Monospace', style: 'CODE', icon: <SpaceBar /> },\n]\n\nconst styleMap = {\n  CODE: {\n    backgroundColor: 'rgba(0, 0, 0, 0.05)',\n    fontFamily: '\"Inconsolata\", \"Menlo\", \"Consolas\", monospace',\n    fontSize: 16,\n    padding: 2,\n  },\n}\n\nconst getBlockStyle = (block: ContentBlock): string => {\n  switch (block.getType()) {\n    case 'blockquote':\n      return 'RichEditor-blockquote'\n    default:\n      return ''\n  }\n}\n\ninterface StyleButtonProps {\n  onToggle: (inlineStyle: string) => void\n  style: string\n  active: boolean\n  label: string\n  icon?: React.ReactElement\n}\n\nconst StyleButton: React.FunctionComponent<StyleButtonProps> = ({\n  onToggle,\n  style,\n  active,\n  label,\n  icon,\n}) => {\n  const onToggleWrap: React.EventHandler<React.SyntheticEvent> = e => {\n    e.preventDefault()\n    onToggle(style)\n  }\n\n  let className = 'RichEditor-styleButton'\n  if (active) {\n    className += ' RichEditor-activeButton'\n  }\n\n  return icon ? (\n    <IconButton size=\"small\" onMouseDown={onToggleWrap} className={className}>\n      {icon}\n    </IconButton>\n  ) : (\n    <Button\n      size=\"small\"\n      startIcon={icon ? icon : undefined}\n      onMouseDown={onToggleWrap}\n      className={className}\n    >\n      {icon ? '' : label}\n    </Button>\n  )\n}\n\ninterface BlockStyleControlsProps {\n  editorState: EditorState\n  onToggle: (style: string) => void\n}\n\nconst BlockStyleControls: React.FunctionComponent<BlockStyleControlsProps> = ({\n  editorState,\n  onToggle,\n}) => {\n  const selection = editorState.getSelection()\n  const blockType = editorState\n    .getCurrentContent()\n    .getBlockForKey(selection.getStartKey())\n    .getType()\n\n  return (\n    <div className=\"RichEditor-controls\">\n      {BLOCK_TYPES.map(type => (\n        <StyleButton\n          key={type.label}\n          active={type.style === blockType}\n          label={type.label}\n          icon={type.icon}\n          onToggle={onToggle}\n          style={type.style}\n        />\n      ))}\n    </div>\n  )\n}\n\ninterface InlineStyleControlsProps {\n  editorState: EditorState\n  onToggle: (style: string) => void\n}\n\nconst InlineStyleControls: React.FunctionComponent<InlineStyleControlsProps> = ({\n  editorState,\n  onToggle,\n}) => {\n  const currentStyle = editorState.getCurrentInlineStyle()\n  return (\n    <div className=\"RichEditor-controls\">\n      {INLINE_STYLES.map(type => (\n        <StyleButton\n          key={type.label}\n          active={currentStyle.has(type.style)}\n          label={type.label}\n          icon={type.icon}\n          onToggle={onToggle}\n          style={type.style}\n        />\n      ))}\n    </div>\n  )\n}\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    root: {\n      width: '100%',\n    },\n    input: {\n      padding: 0,\n    },\n    toolbar: {\n      padding: 0,\n    },\n  }),\n)\n\ninterface NoteEditorProps {\n  note?: Instance<typeof Note>\n  text?: string\n  placeholder?: string\n  autoFocus?: boolean\n  className?: string\n  onValue?: (\n    value?: Instance<typeof Note>,\n    event?: React.FocusEvent | React.KeyboardEvent,\n  ) => void | null | string\n}\n\nexport const NoteEditor = React.forwardRef<Editor, NoteEditorProps>(\n  ({ note, text, placeholder, autoFocus, onValue, className }, ref) => {\n    const classes = useStyles()\n    const rawContentState = note?.rawContentState\n    const contentState = React.useMemo(\n      () => rawContentState && convertFromRaw(JSON.parse(rawContentState)),\n      [rawContentState],\n    )\n    const [editorState, setEditorState] = React.useState(() =>\n      EditorState.createWithContent(\n        contentState || ContentState.createFromText(text ?? note?.label ?? ''),\n      ),\n    )\n\n    const [didRender, setDidRender] = React.useState(false)\n    /* React.useEffect(() => { */\n    /*   if (!didRender && autoFocus) { */\n    /*     console.log(ref) */\n    /*     setDidRender(true) */\n    /*   } */\n    /* }, [didRender, autoFocus, editorState]) */\n\n    const handleValue = (\n      event?: React.KeyboardEvent<HTMLInputElement>,\n    ): void => {\n      const contentState = editorState.getCurrentContent()\n      const rawContent = convertToRaw(contentState)\n\n      if (note) {\n        note.setRawContentState(rawContent)\n        note.setLabel(contentState.getFirstBlock().getText())\n      }\n\n      if (onValue) {\n        onValue(note, event)\n      }\n    }\n\n    const handleBlur = (event: React.FocusEvent<HTMLInputElement>): void => {\n      handleValue()\n    }\n\n    const handleKeyCommand = (\n      command: DraftEditorCommand,\n      editorState: EditorState,\n    ): DraftHandleValue => {\n      const newState = RichUtils.handleKeyCommand(editorState, command)\n      if (newState) {\n        setEditorState(newState)\n        return 'handled'\n      } else {\n        return 'not-handled'\n      }\n    }\n\n    const mapKeyToEditorCommand = (\n      event: React.KeyboardEvent,\n    ): DraftEditorCommand | null => {\n      if (event.keyCode === 13 && event.shiftKey) {\n        handleValue()\n        return null\n      } else {\n        return getDefaultKeyBinding(event)\n      }\n    }\n\n    const toggleBlockType = (blockType: string): void => {\n      setEditorState(RichUtils.toggleBlockType(editorState, blockType))\n    }\n\n    const toggleInlineStyle = (inlineStyle: string): void => {\n      setEditorState(RichUtils.toggleInlineStyle(editorState, inlineStyle))\n    }\n\n    return (\n      <div className={[classes.root, className].join(' ')}>\n        <div className={classes.input}>\n          <Editor\n            ref={ref}\n            blockStyleFn={getBlockStyle}\n            customStyleMap={styleMap}\n            editorState={editorState}\n            handleKeyCommand={handleKeyCommand}\n            keyBindingFn={mapKeyToEditorCommand}\n            onChange={setEditorState}\n            onBlur={handleBlur}\n            placeholder={placeholder}\n            spellCheck={true}\n          />\n        </div>\n\n        <Toolbar variant=\"dense\" className={classes.toolbar}>\n          <Box flexGrow={1}>\n            <InlineStyleControls\n              editorState={editorState}\n              onToggle={toggleInlineStyle}\n            />\n          </Box>\n          <BlockStyleControls\n            editorState={editorState}\n            onToggle={toggleBlockType}\n          />\n        </Toolbar>\n      </div>\n    )\n  },\n)\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport {\n  types,\n  IAnyType,\n  Instance,\n  getParentOfType,\n  getSnapshot,\n} from 'mobx-state-tree'\n\nimport { Note } from 'note'\nimport { nodeFactory, edgeMapFactory, Config, Graph } from 'graph'\n\nexport const Node = nodeFactory([\n  edgeMapFactory(() =>\n    types.union(\n      types.late((): IAnyType => Node),\n      nodeFactory(Config),\n      nodeFactory(Note),\n    ),\n  ),\n])\n  .props({\n    label: types.optional(types.string, ''),\n  })\n  .actions(self => ({\n    setLabel(label: string): void {\n      self.label = label\n    },\n\n    graphRoot(): Instance<IAnyType> {\n      return getParentOfType(self, Graph)\n    },\n\n    getConfig(): Instance<typeof Config> {\n      console.log('node label', self.label)\n      console.log(self.edgeMap.get('config')?.length)\n\n      if (self.edgeMap.get('config')?.length) {\n        return self.edgeMap.get('config')?.[0]\n      }\n\n      const config = self.graphRoot().createNode('Config', {})\n      console.log('config', getSnapshot(config))\n      // self.addEdge('config', config)\n\n      return config\n    },\n\n    toggleExpand(node: Instance<IAnyType>, parentNode: Instance<IAnyType>) {\n      const config = self.getConfig()\n      let expandedNodes = config.get('expandedNodes')\n\n      if (!expandedNodes) {\n        expandedNodes = config.set('expandedNodes', {})\n      }\n\n      const nodeIds = expandedNodes.get(parentNode.id)\n\n      if (nodeIds) {\n        if (nodeIds.includes(node.id)) {\n          nodeIds.remove(node.id)\n          if (nodeIds.length === 0) {\n            expandedNodes.delete(parentNode.id)\n          }\n        } else {\n          nodeIds.push(node.id)\n        }\n      } else {\n        expandedNodes.set(parentNode.id, [node.id])\n      }\n    },\n\n    isExpanded(\n      node: Instance<IAnyType>,\n      parentNode: Instance<IAnyType>,\n    ): boolean {\n      self.getConfig()\n      return false\n      // return self\n      //   .getConfig()\n      //   .get('expandedNodes')\n      //   ?.get(parentNode.id)\n      //   ?.includes(node.id)\n    },\n  }))\n  .views(self => ({\n    get childCount(): number {\n      return self.edgeMap.get('child')?.length ?? 0\n    },\n\n    get expandedNodes() {\n      return self.getConfig().get('expandedNodes')\n    },\n  }))\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport { Typography, Toolbar, IconButton } from '@material-ui/core'\nimport { createStyles, makeStyles, Theme } from '@material-ui/core/styles'\nimport ChevronLeftIcon from '@material-ui/icons/ChevronLeft'\nimport SettingsIcon from '@material-ui/icons/Settings'\nimport { Link } from '@reach/router'\n\nimport { makeUrl } from 'route'\nimport { isRootPath } from 'common'\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    root: {\n      color: theme.palette.text.secondary,\n      backgroundColor: theme.palette.background.default,\n      padding: theme.spacing(0, 2, 0, 2),\n    },\n    backButton: {\n      '&[disabled]': {\n        visibility: 'hidden',\n        pointerEvents: 'none',\n      },\n    },\n    hide: {\n      visibility: 'hidden',\n      mouseEvents: 'none',\n    },\n    settingsButton: {},\n    title: {\n      flexGrow: 1,\n      textAlign: 'center',\n      overflowX: 'hidden',\n      whiteSpace: 'nowrap',\n      textOverflow: 'ellipsis',\n      color: theme.palette.text.primary,\n    },\n  }),\n)\n\ninterface TitleBarProps {\n  title?: string\n  showBackButton?: boolean\n  showSettingsButton?: boolean\n  className?: string\n}\n\nexport const TitleBar: React.FunctionComponent<TitleBarProps> = ({\n  title,\n  showBackButton,\n  showSettingsButton,\n  className,\n  children,\n}) => {\n  const classes = useStyles()\n  const newlinePosition = title?.indexOf('\\n') ?? -1\n\n  return (\n    <Toolbar variant=\"dense\" className={[classes.root, className].join(' ')}>\n      <IconButton\n        disabled={isRootPath()}\n        edge=\"start\"\n        aria-label=\"back\"\n        onClick={() => window.history.back()}\n        className={[\n          classes.backButton,\n          showBackButton ? '' : classes.hide,\n        ].join(' ')}\n      >\n        <ChevronLeftIcon />\n      </IconButton>\n\n      {title && (\n        <Typography variant=\"h6\" className={classes.title}>\n          {newlinePosition > 0 ? title.slice(0, title.indexOf('\\n')) : title}\n        </Typography>\n      )}\n\n      <IconButton\n        disabled\n        edge=\"end\"\n        component={Link}\n        to={makeUrl(`/settings`)}\n        aria-label=\"settings\"\n        className={[\n          classes.settingsButton,\n          showSettingsButton ? '' : classes.hide,\n        ].join(' ')}\n      >\n        {<SettingsIcon fontSize=\"small\" />}\n      </IconButton>\n    </Toolbar>\n  )\n}\n\nTitleBar.defaultProps = {\n  title: 'Exuo',\n  showBackButton: true,\n  showSettingsButton: false,\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport { types, IAnyType } from 'mobx-state-tree'\n\nexport const Unknown = types.union(\n  types.null,\n  types.boolean,\n  types.string,\n  types.number,\n  types.array(types.late((): IAnyType => Unknown)),\n  types.map(types.late((): IAnyType => Unknown)),\n)\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport { types, SnapshotIn, Instance } from 'mobx-state-tree'\n\nimport { Unknown } from './Unknown'\n\nexport const Config = types\n  .model('Config', {\n    name: types.maybe(types.string),\n    items: types.map(Unknown),\n  })\n  .actions(self => ({\n    set(\n      key: string,\n      value: SnapshotIn<typeof Unknown>,\n    ): SnapshotIn<typeof Unknown> {\n      return self.items.set(key, value)\n    },\n  }))\n  .views(self => ({\n    get(key: string): Instance<typeof Unknown> {\n      return self.items.get(key)\n    },\n  }))\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport {\n  Instance,\n  applySnapshot,\n  getSnapshot,\n  SnapshotIn,\n  SnapshotOut,\n  IAnyModelType,\n} from 'mobx-state-tree'\n\nimport { persist } from 'store/persist'\nimport { Note } from 'note'\n\nimport { graphFactory, nodeFactory } from './factories'\nimport { Node } from './Node'\nimport { Config } from './Config'\n\nexport const Graph = graphFactory({\n  Node,\n  Config: nodeFactory(Config),\n  Note: nodeFactory(Note),\n})\n  .actions(self => ({\n    setActiveMode(mode: string) {\n      const activeModes = self.activeModes\n      if (!activeModes?.includes(mode)) {\n        activeModes.push(mode)\n      }\n    },\n\n    unsetActiveMode(mode: string) {\n      const activeModes = self.activeModes\n      if (activeModes?.includes(mode)) {\n        activeModes.remove(mode)\n      }\n    },\n\n    toggleActiveMode(mode: string) {\n      const activeModes = self.activeModes\n\n      if (!activeModes) {\n        return\n      }\n\n      // TODO mode logic doesn't belong here\n      if (activeModes.includes(mode)) {\n        activeModes.remove(mode)\n\n        if (mode === 'select') {\n          self.clearSelectedNodes()\n        }\n      } else {\n        activeModes.push(mode)\n\n        if (mode === 'select') {\n          activeModes.remove('edit')\n        }\n\n        if (mode === 'edit') {\n          activeModes.remove('select')\n          self.clearSelectedNodes()\n        }\n      }\n    },\n  }))\n\n  .actions(self => ({\n    toggleSelectNode(\n      node: Instance<typeof Node>,\n      parentNode: Instance<typeof Node>,\n    ) {\n      const selectedNodes = self.Config.get('system').get('selectedNodes')\n      if (!selectedNodes) {\n        return\n      }\n\n      const nodeIds = selectedNodes.get(parentNode.id)\n\n      if (nodeIds) {\n        if (nodeIds.includes(node.id)) {\n          nodeIds.remove(node.id)\n          if (nodeIds.length === 0) {\n            selectedNodes.delete(parentNode.id)\n          }\n        } else {\n          nodeIds.push(node.id)\n        }\n      } else {\n        selectedNodes.set(parentNode.id, [node.id])\n      }\n    },\n\n    clearSelectedNodes() {\n      self.Config.get('system').get('selectedNodes')?.clear()\n      if (self.selectedNodes.size === 0) {\n        self.unsetActiveMode('select')\n      }\n    },\n\n    deleteSelectedNodes() {\n      self.selectedNodes.forEach((nodeIds: Array<string>) =>\n        nodeIds.forEach((nodeId: string) => self.Node.delete(nodeId)),\n      )\n\n      self.clearSelectedNodes()\n    },\n\n    moveSelectedNodes() {\n      for (const [accessorId, nodeIds] of self.selectedNodes) {\n        const accessor = self.Node.get(accessorId)\n        for (const nodeId of nodeIds) {\n          const node = self.Node.get(nodeId)\n          if (node) {\n            node.removeEdge('parent', accessor)\n            accessor.removeEdge('child', node)\n\n            node.addEdge('parent', self.cursorNode)\n            self.cursorNode.addEdge('child', node)\n          }\n        }\n      }\n\n      self.clearSelectedNodes()\n    },\n\n    copySelectedNodes() {\n      //\n    },\n\n    linkSelectedNodes() {\n      for (const nodeIds of self.selectedNodes.values()) {\n        for (const nodeId of nodeIds) {\n          const node = self.Node.get(nodeId)\n          if (node) {\n            node.addEdge('parent', self.cursorNode)\n            self.cursorNode.addEdge('child', node)\n          }\n        }\n      }\n\n      self.clearSelectedNodes()\n    },\n\n    unlinkSelectedNodes() {\n      for (const [accessorId, nodeIds] of self.selectedNodes) {\n        const accessor = self.Node.get(accessorId)\n        for (const nodeId of nodeIds) {\n          const node = self.Node.get(nodeId)\n          if (node) {\n            node.removeEdge('parent', accessor)\n            accessor.removeEdge('child', node)\n          }\n        }\n      }\n\n      self.clearSelectedNodes()\n    },\n\n    removeSelectedNodes() {\n      for (const [accessorId, nodeIds] of self.selectedNodes) {\n        const accessor = self.Node.get(accessorId)\n        for (const nodeId of nodeIds) {\n          const node = self.Node.get(nodeId)\n          if (node) {\n            node.removeEdge('parent', accessor)\n            accessor.removeEdge('child', node)\n            if (node.edgeMap.get('parent').size === 0) {\n              self.deleteNode(node)\n            }\n          }\n        }\n      }\n\n      self.clearSelectedNodes()\n    },\n\n    setCursorNode(node: Instance<typeof Node>) {\n      self.Config.get('system').set('cursorNodeId', node.id)\n    },\n  }))\n\n  .actions(self => ({\n    afterCreate() {\n      persist(self)\n        .catch(e => {\n          console.error('Persist error', e)\n        })\n        .then(() => {\n          if (!self.rootNode) {\n            const rootNode = self.createNode('Node', { label: 'Exuo' })\n            applySnapshot(self.Config, {\n              system: {\n                id: 'system',\n                items: {\n                  rootNodeId: rootNode.id,\n                  selectedNodes: {},\n                  activeModes: [],\n                },\n              },\n            })\n          }\n        })\n    },\n\n    createChild<T extends IAnyModelType>(\n      node: Instance<typeof Node>,\n      edgeProps: SnapshotIn<T>,\n      edgeType = 'Node',\n    ): Instance<typeof Node> {\n      const child = self.createNode(edgeType, edgeProps)\n\n      node.addEdge('child', child)\n      child.addEdge('parent', node)\n\n      return child\n    },\n\n    deleteNode(node: Instance<typeof Node>) {\n      self.Node.delete(node.id)\n    },\n  }))\n\n  .views(self => ({\n    get rootNode() {\n      const config = self.Config.get('system')\n      return self.Node.get(config?.get('rootNodeId'))\n    },\n\n    get cursorNode() {\n      const config = self.Config.get('system')\n      return self.Node.get(config.get('cursorNodeId')) ?? self.rootNode\n    },\n\n    get activeModes() {\n      const config = self.Config.get('system')\n      return config?.get('activeModes')\n    },\n\n    get selectedNodes() {\n      const config = self.Config.get('system')\n      return config?.get('selectedNodes')\n    },\n\n    get selectedNodeCount() {\n      let count = 0\n\n      for (const kv of self.selectedNodes) {\n        count += kv[1].length\n      }\n\n      return count\n    },\n  }))\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport {\n  Collapse,\n  Button,\n  ListItem,\n  ListItemSecondaryAction,\n  ListItemText,\n  ListItemIcon,\n} from '@material-ui/core'\nimport ChevronRightIcon from '@material-ui/icons/ChevronRight'\nimport KeyboardArrowDownIcon from '@material-ui/icons/KeyboardArrowDown'\nimport { createStyles, makeStyles, fade, Theme } from '@material-ui/core/styles'\nimport { Instance } from 'mobx-state-tree'\nimport { Link, useNavigate } from '@reach/router'\n\nimport { makeUrl } from 'route'\nimport { useGraph, Node, LabelEditor, EdgeList, Config } from 'graph'\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    itemContainer: {\n      '&.isExpanded': {\n        /* background: theme.palette.background.default, */\n        /* position: 'sticky', */\n        /* top: 65, */\n      },\n    },\n\n    listItem: {\n      cursor: 'pointer',\n\n      transition: theme.transitions.create(['color'], {\n        duration: theme.transitions.duration.shortest,\n      }),\n\n      '&:hover, &:focus': {\n        color: theme.palette.primary.main,\n      },\n\n      '&.editMode': {\n        cursor: 'text',\n        color: 'unset',\n      },\n\n      '&.selectMode': {\n        cursor: 'default',\n        color: 'unset',\n      },\n\n      '&.Mui-selected': {\n        background: `\n          linear-gradient(\n            to top,\n            ${fade(theme.palette.background.default, 0)},\n            ${fade(theme.palette.background.default, 0.8)} \\\n              ${theme.spacing(1) / 3}px calc(100% - ${theme.spacing(1) / 3}px),\n            ${fade(theme.palette.background.default, 0)}\n          ),\n          linear-gradient(\n            to right,\n            ${theme.palette.primary.main},\n            ${theme.palette.secondary.main} \n          )\n        `,\n\n        '&:hover': { color: 'unset' },\n        '& a:hover': { color: 'unset' },\n      },\n\n      '&.isEditing': {\n        padding: 0,\n\n        // From EdgeList but it conflicts here slightly, so hide it\n        borderTop: `.01px solid ${fade(theme.palette.divider, 0)}`,\n        '&+li': {\n          borderTop: `.01px solid ${fade(theme.palette.divider, 0)}`,\n        },\n      },\n    },\n\n    childList: {\n      marginLeft: theme.spacing(3),\n      padding: 0,\n    },\n\n    itemText: {\n      margin: 0,\n      overflowX: 'hidden',\n      whiteSpace: 'nowrap',\n      textOverflow: 'ellipsis',\n\n      '& .MuiListItemText-primary': {\n        display: 'inline',\n      },\n\n      '& .MuiListItemText-secondary': {\n        display: 'inline',\n        paddingLeft: theme.spacing(1),\n      },\n\n      '&.expand': {\n        '& .MuiListItemText-secondary': {\n          display: 'block',\n          paddingLeft: 0,\n        },\n      },\n    },\n\n    listItemSelectCheckbox: {\n      padding: theme.spacing(0, 1, 0, 1),\n      '&:hover, &.Mui-checked:hover': {\n        backgroundColor: 'unset',\n      },\n    },\n\n    listItemIcon: {\n      minWidth: 'auto',\n    },\n\n    labelEditor: {\n      background: `\n          linear-gradient(\n            to top,\n            ${fade(theme.palette.background.default, 0)},\n            ${fade(theme.palette.background.default, 1)} \\\n              ${theme.spacing(1) / 3}px calc(100% - ${theme.spacing(1) / 3}px),\n            ${fade(theme.palette.background.default, 0)}\n          ),\n          linear-gradient(\n            to right,\n            ${theme.palette.primary.main},\n            ${theme.palette.secondary.main} \n          )\n        `,\n    },\n\n    secondaryActions: {\n      right: 0,\n    },\n\n    childButton: {\n      cursor: 'pointer',\n      color: theme.palette.text.primary,\n      transition: theme.transitions.create(['color'], {\n        duration: theme.transitions.duration.shortest,\n      }),\n\n      // Ensure ChevronRight lines up without a label\n      minWidth: 'unset',\n      paddingLeft: theme.spacing(2),\n      paddingRight: theme.spacing(2),\n\n      '&:hover, &:focus': {\n        color: theme.palette.primary.main,\n        background: 'inherit',\n      },\n    },\n  }),\n)\n\ninterface NodeListItemProps {\n  node: Instance<typeof Node>\n  parentNode: Instance<typeof Node>\n  expandSecondaryTypography?: boolean\n  expanded?: boolean\n}\n\nexport const NodeListItem: React.FunctionComponent<NodeListItemProps> = ({\n  node,\n  parentNode,\n  expandSecondaryTypography,\n  expanded,\n  ...props\n}) => {\n  const classes = useStyles()\n  const navigate = useNavigate()\n  const [isEditing, setIsEditing] = React.useState(false)\n\n  /* const isMouseDown = React.useRef(false) */\n  /* const timer = React.useRef<ReturnType<typeof setTimeout>>() */\n\n  return useGraph(graph => {\n    const cursorNode = graph.cursorNode\n    /* const isExpanded = cursorNode.isExpanded(node, parentNode) */\n    const isExpanded = false\n    const toggleExpand = (): void => {\n      cursorNode.toggleExpand(node, parentNode)\n      console.log(graph.cursorNode.expandedNodes)\n    }\n\n    /* const downHandler: React.EventHandler<React.SyntheticEvent> = e => { */\n    /*   e.preventDefault() */\n    /*   e.persist() */\n\n    /*   isMouseDown.current = true */\n\n    /*   timer.current = setTimeout(() => { */\n    /*     isMouseDown.current = false */\n\n    /*     if (graph.activeModes.includes('edit')) { */\n    /*       return */\n    /*     } */\n\n    /*     if (timer.current) { */\n    /*       clearTimeout(timer.current) */\n    /*     } */\n\n    /*     graph.toggleActiveMode('select') */\n    /*     if (graph.activeModes.includes('select')) { */\n    /*       graph.toggleSelectNode(node) */\n    /*     } */\n    /*   }, 190) */\n    /* } */\n\n    /* const upHandler: React.EventHandler<React.SyntheticEvent> = e => { */\n    /*   if (!isMouseDown.current) { */\n    /*     return */\n    /*   } */\n\n    /*   isMouseDown.current = false */\n    /*   e.preventDefault() */\n\n    /*   if (graph.activeModes.includes('select')) { */\n    /*     graph.toggleSelectNode(node) */\n    /*   } else if (graph.activeModes.includes('edit')) { */\n    /*     setIsEditing(true) */\n    /*   } else { */\n    /*     navigate(makeUrl(`/node/${node.id}`)) */\n    /*   } */\n\n    /*   if (timer.current) { */\n    /*     clearTimeout(timer.current) */\n    /*   } */\n    /* } */\n\n    const handleItemClick: React.EventHandler<React.MouseEvent> = e => {\n      e.preventDefault()\n\n      if (e.altKey) {\n        toggleExpand()\n      } else if (graph.activeModes.includes('select')) {\n        graph.toggleSelectNode(node, parentNode)\n      } else if (graph.activeModes.includes('edit')) {\n        setIsEditing(true)\n      } else if (e.metaKey || e.ctrlKey) {\n        graph.toggleActiveMode('select')\n        graph.toggleSelectNode(node, parentNode)\n      } else {\n        graph.setCursorNode(node)\n        navigate(makeUrl(`/node/${node.id}/`))\n      }\n    }\n\n    const handleArrowClick: React.EventHandler<React.MouseEvent> = e => {\n      if (e.altKey) {\n        e.preventDefault()\n        toggleExpand()\n        return\n      }\n\n      if (graph.activeModes.includes('select')) {\n        graph.setCursorNode(node)\n      }\n    }\n\n    const isSelected = graph.selectedNodes.get(parentNode.id)?.includes(node.id)\n    const newlinePosition = node.label.indexOf('\\n')\n\n    return (\n      <>\n        <ListItem\n          onClick={handleItemClick}\n          selected={isSelected}\n          ContainerProps={{\n            className: [\n              classes.itemContainer,\n              node.childCount > 0 && isExpanded ? 'isExpanded' : '',\n            ].join(' '),\n          }}\n          className={[\n            classes.listItem,\n            graph.activeModes.includes('edit') ? 'editMode' : '',\n            graph.activeModes.includes('select') ? 'selectMode' : '',\n            isEditing ? 'isEditing' : '',\n          ].join(' ')}\n        >\n          {isEditing ? (\n            <LabelEditor\n              label={node.label}\n              autoFocus\n              className={classes.labelEditor}\n              onValue={value => {\n                setIsEditing(false)\n                if (value) {\n                  node.setLabel(value)\n                }\n              }}\n            />\n          ) : (\n            <ListItemText\n              primary={\n                newlinePosition > 0\n                  ? node.label.slice(0, newlinePosition)\n                  : node.label\n              }\n              secondary={\n                newlinePosition > 0\n                  ? node.label.slice(newlinePosition + 1)\n                  : undefined\n              }\n              className={[\n                classes.itemText,\n                expandSecondaryTypography ? 'expand' : '',\n              ].join(' ')}\n            />\n          )}\n\n          {!isEditing && (\n            <ListItemSecondaryAction className={classes.secondaryActions}>\n              {(node.childCount > 0 ||\n                graph.activeModes.includes('select') ||\n                graph.activeModes.includes('edit')) && (\n                <Button\n                  to={makeUrl(`/node/${node.id}/`)}\n                  component={Link}\n                  onClick={handleArrowClick}\n                  className={classes.childButton}\n                  endIcon={\n                    node.childCount > 0 && isExpanded ? (\n                      <KeyboardArrowDownIcon />\n                    ) : (\n                      <ChevronRightIcon />\n                    )\n                  }\n                  size=\"small\"\n                >\n                  {node.childCount > 0 && node.childCount}\n                </Button>\n              )}\n            </ListItemSecondaryAction>\n          )}\n        </ListItem>\n\n        {node.childCount > 0 && (\n          <Collapse in={isExpanded} timeout=\"auto\" unmountOnExit>\n            <EdgeList\n              node={node}\n              edgeTag=\"child\"\n              className={classes.childList}\n            />\n          </Collapse>\n        )}\n      </>\n    )\n  })\n}\n\nNodeListItem.defaultProps = {\n  expandSecondaryTypography: true,\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport { List } from '@material-ui/core'\nimport { createStyles, makeStyles, Theme } from '@material-ui/core/styles'\nimport { IAnyModelType, Instance } from 'mobx-state-tree'\n\nimport { useGraph } from '../useGraph'\nimport { NodeListItem } from './NodeListItem'\nimport { Node } from '../models/Node'\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    list: {\n      padding: 0,\n      '&>li': {\n        borderTop: `.01px solid ${theme.palette.divider}`,\n      },\n\n      '&.outer': {\n        borderBottom: `.01px solid ${theme.palette.divider}`,\n      },\n    },\n  }),\n)\n\ninterface EdgeListProps {\n  node: Instance<IAnyModelType>\n  edgeTag: string\n  outer?: boolean\n  className?: string\n}\n\n/* React.useEffect(() => { */\n/*   if (didAdd) { */\n/*     window.scrollTo({ */\n/*       left: 0, */\n/*       top: document.body.scrollHeight, */\n/*     }) */\n\n/*     setDidAdd(false) */\n/*   } */\n/* }, [didAdd]) */\n\n// It's time to pluck list specific stuff out of NodeListItem\n// and put it into EdgeList. Child counter / expand, checkboxes, selection, etc.\n// Keep NodeListItem to rendering just the item content.\n// That way isEditing, isSelected, isExpanded are all much simplified and separated from\n// the logic for display and editing of items.\n\nexport const EdgeList: React.FunctionComponent<EdgeListProps> = ({\n  node,\n  edgeTag,\n  outer,\n  className,\n}) => {\n  const classes = useStyles()\n  return useGraph(graph => (\n    <List\n      aria-label=\"edge list\"\n      className={[classes.list, outer ? 'outer' : '', className].join(' ')}\n    >\n      {node.edgeMap.get(edgeTag)?.map((item: Instance<typeof Node>) => (\n        <NodeListItem\n          node={item}\n          parentNode={node}\n          key={`${node.id}-${edgeTag}-${item.id}`}\n        />\n      ))}\n    </List>\n  ))\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport { makeStyles, Theme, createStyles } from '@material-ui/core/styles'\nimport { InputBase, ClickAwayListener } from '@material-ui/core'\n\nimport { useGraph } from 'graph'\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    root: {\n      display: 'inline-block',\n      margin: 0,\n      padding: theme.spacing(1, 2, 1, 2),\n      overflowX: 'hidden',\n      whiteSpace: 'nowrap',\n      textOverflow: 'ellipsis',\n      ...theme.typography.body1,\n    },\n  }),\n)\n\ninterface LabelEditorProps {\n  label?: string\n  placeholder?: string\n  autoFocus?: boolean\n  className?: string\n  onValue?: (\n    value: string,\n    event?: React.KeyboardEvent<HTMLInputElement>,\n  ) => void\n}\n\nexport const LabelEditor: React.FunctionComponent<LabelEditorProps> = ({\n  label,\n  placeholder,\n  autoFocus,\n  className,\n  onValue,\n}) => {\n  const inputRef = React.useRef<HTMLInputElement>()\n  const classes = useStyles()\n  const [inputValue, setInputValue] = React.useState(label ?? '')\n\n  const [didRender, setDidRender] = React.useState(false)\n  React.useEffect(() => {\n    if (!didRender) {\n      inputRef.current?.setSelectionRange(inputValue.length, inputValue.length)\n      setDidRender(true)\n    }\n  }, [didRender, inputValue.length])\n\n  return useGraph(graph => {\n    const handleValue = (\n      event?: React.KeyboardEvent<HTMLInputElement>,\n    ): void => {\n      if (onValue) {\n        setInputValue('')\n        onValue(inputValue, event)\n      }\n    }\n\n    const handleClickAway = (event: React.MouseEvent<Document>): void => {\n      handleValue()\n    }\n\n    const handleKeyDown = (\n      event: React.KeyboardEvent<HTMLInputElement>,\n    ): void => {\n      if (event.keyCode === 13 && !event.shiftKey) {\n        event.preventDefault()\n        handleValue(event)\n      }\n    }\n\n    const handleChange = (event: React.ChangeEvent<HTMLInputElement>): void => {\n      setInputValue(event.target.value)\n    }\n\n    return (\n      <ClickAwayListener onClickAway={handleClickAway}>\n        <InputBase\n          fullWidth\n          multiline\n          autoFocus={autoFocus}\n          inputRef={inputRef}\n          placeholder={placeholder}\n          value={inputValue}\n          onKeyDown={handleKeyDown}\n          onChange={handleChange}\n          inputProps={{ 'aria-label': 'label' }}\n          className={[classes.root, className].join(' ')}\n        />\n      </ClickAwayListener>\n    )\n  })\n}\n\nLabelEditor.defaultProps = {\n  placeholder: 'Label',\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport { Instance } from 'mobx-state-tree'\nimport {\n  IconButton,\n  Button,\n  ButtonGroup,\n  ClickAwayListener,\n  Paper,\n  Popper,\n  MenuItem,\n  MenuList,\n  IconButtonProps,\n} from '@material-ui/core'\nimport DeleteIcon from '@material-ui/icons/DeleteOutlined'\nimport FlipToBackIcon from '@material-ui/icons/FlipToBackOutlined'\nimport CancelIcon from '@material-ui/icons/CancelOutlined'\nimport FolderIcon from '@material-ui/icons/FolderOutlined'\nimport FileCopyIcon from '@material-ui/icons/FileCopyOutlined'\nimport CropFreeIcon from '@material-ui/icons/CropFreeOutlined'\nimport { createStyles, makeStyles, Theme } from '@material-ui/core/styles'\n\nimport { useGraph, Node } from 'graph'\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    root: {\n      display: 'inherit',\n      position: 'relative',\n    },\n    buttonGroup: {\n      '& .MuiButtonGroup-groupedTextHorizontal': {\n        borderRight: 'unset',\n      },\n      '& .MuiButtonGroup-grouped': {\n        minWidth: 'unset',\n      },\n    },\n    selectCount: {\n      color: theme.palette.primary.main,\n      fontSize: 12,\n      position: 'absolute',\n      width: '100%',\n      bottom: -theme.spacing(1),\n    },\n    selectButton: {},\n    deleteButton: {\n      color: theme.palette.error.main,\n    },\n    popper: {\n      '& svg': {\n        marginRight: theme.spacing(1),\n      },\n    },\n    paper: {\n      border: `.01px solid ${theme.palette.divider}`,\n    },\n    selectMenu: {\n      outline: 0,\n    },\n  }),\n)\n\ninterface SelectButtonProps extends IconButtonProps {\n  node: Instance<typeof Node>\n  onClick: React.MouseEventHandler\n  className?: string\n}\n\nexport const SelectButton: React.FunctionComponent<SelectButtonProps> = ({\n  node,\n  className,\n  onClick,\n  ...extraProps\n}) => {\n  const classes = useStyles()\n  const [open, setOpen] = React.useState(false)\n  const anchorRef = React.useRef<HTMLButtonElement>(null)\n\n  return useGraph(graph => {\n    const selectedCount = graph.selectedNodeCount\n    return (\n      <div className={[classes.root, className].join(' ')}>\n        {selectedCount > 0 && (\n          <span className={classes.selectCount}>{selectedCount}</span>\n        )}\n        <IconButton\n          color=\"primary\"\n          ref={anchorRef}\n          onClick={\n            graph.selectedNodes.size ? () => setOpen(value => !value) : onClick\n          }\n          className={classes.selectButton}\n          {...extraProps}\n        >\n          <CropFreeIcon />\n        </IconButton>\n        <Popper\n          open={open}\n          anchorEl={anchorRef.current}\n          role={undefined}\n          disablePortal\n          className={classes.popper}\n        >\n          {({ placement }) => (\n            <ClickAwayListener\n              onClickAway={e => {\n                e.preventDefault()\n                setOpen(false)\n              }}\n            >\n              <Paper elevation={0} className={classes.paper}>\n                <MenuList dense className={classes.selectMenu}>\n                  <MenuItem\n                    divider\n                    onClick={() => {\n                      graph.removeSelectedNodes()\n                      setOpen(false)\n                    }}\n                    className={classes.deleteButton}\n                  >\n                    <DeleteIcon />\n                    Remove\n                  </MenuItem>\n\n                  <MenuItem\n                    onClick={() => {\n                      graph.linkSelectedNodes()\n                      setOpen(false)\n                    }}\n                  >\n                    <FlipToBackIcon />\n                    Link here\n                  </MenuItem>\n\n                  <MenuItem\n                    disabled\n                    onClick={() => {\n                      setOpen(false)\n                    }}\n                  >\n                    <FileCopyIcon />\n                    Copy here\n                  </MenuItem>\n\n                  <MenuItem\n                    divider\n                    onClick={() => {\n                      graph.moveSelectedNodes()\n                      setOpen(false)\n                    }}\n                  >\n                    <FolderIcon />\n                    Move here\n                  </MenuItem>\n\n                  {/* <MenuItem */}\n                  {/*   onClick={() => { */}\n                  {/*     graph.deleteSelectedNodes() */}\n                  {/*     setOpen(false) */}\n                  {/*   }} */}\n                  {/*   className={classes.deleteButton} */}\n                  {/* > */}\n                  {/*   <DeleteIcon /> */}\n                  {/*   Delete */}\n                  {/* </MenuItem> */}\n\n                  <MenuItem\n                    onClick={() => {\n                      graph.clearSelectedNodes()\n                      setOpen(false)\n                    }}\n                  >\n                    <CancelIcon />\n                    Clear selection\n                  </MenuItem>\n                </MenuList>\n              </Paper>\n            </ClickAwayListener>\n          )}\n        </Popper>\n      </div>\n    )\n  })\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport {\n  Toolbar,\n  IconButton,\n  Box,\n  Button,\n  createStyles,\n  makeStyles,\n  Theme,\n  emphasize,\n  fade,\n} from '@material-ui/core'\nimport AddIcon from '@material-ui/icons/Add'\nimport EditIcon from '@material-ui/icons/Edit'\nimport SearchIcon from '@material-ui/icons/Search'\nimport TuneIcon from '@material-ui/icons/Tune'\nimport GroupIcon from '@material-ui/icons/Group'\nimport { Instance } from 'mobx-state-tree'\nimport { useNavigate } from '@reach/router'\n\nimport { makeUrl } from 'route'\nimport { SelectButton } from 'select'\nimport { Node, useGraph, LabelEditor } from 'graph'\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    root: {},\n\n    toolbar: {\n      justifyContent: 'space-evenly',\n      [theme.breakpoints.up('sm')]: {\n        justifyContent: 'center',\n      },\n\n      backdropFilter: 'blur(2px)',\n      background: `\n        linear-gradient(\n          to bottom,\n          ${fade(theme.palette.background.default, 0.9)},\n          ${fade(theme.palette.background.default, 1)} 90%\n        )`,\n\n      paddingTop: theme.spacing(1),\n      paddingBottom: theme.spacing(1),\n    },\n\n    insertButton: {\n      color: theme.palette.background.default,\n      textShadow: `3px 3px ${theme.palette.background.default}`,\n      boxShadow: 'unset',\n      margin: theme.spacing(0, 1, 0, 1),\n      backgroundBlendMode: 'normal',\n      background: `\n        radial-gradient(\n          circle at bottom,\n          ${theme.palette.secondary.main},\n          ${theme.palette.primary.main} 75%\n        )`,\n\n      '&:hover, &:focus': {\n        boxShadow: 'unset',\n        background: `\n        radial-gradient(\n          circle at bottom,\n          ${emphasize(theme.palette.secondary.main, 0.3)},\n          ${theme.palette.primary.main} 75%\n        )`,\n      },\n\n      '&:active': {\n        boxShadow: 'unset',\n        background: `\n        radial-gradient(\n          circle at bottom,\n          ${emphasize(theme.palette.secondary.main, 0.3)},\n          ${theme.palette.primary.main} 75%\n        )`,\n      },\n    },\n\n    labelEditor: {\n      background: `\n          linear-gradient(\n            to top,\n            ${fade(theme.palette.background.default, 0)},\n            ${fade(theme.palette.background.default, 1)} \\\n              ${theme.spacing(1) / 3}px calc(100% - ${theme.spacing(1) / 3}px),\n            ${fade(theme.palette.background.default, 0)}\n          ),\n          linear-gradient(\n            to right,\n            ${theme.palette.primary.main},\n            ${theme.palette.secondary.main} \n          )\n        `,\n    },\n  }),\n)\n\ninterface NodeActionsProps {\n  node: Instance<typeof Node>\n  className?: string\n}\n\nexport const NodeActions: React.FunctionComponent<NodeActionsProps> = ({\n  node,\n  className,\n}) => {\n  const classes = useStyles()\n  const navigate = useNavigate()\n\n  // does LabelEditor need to behave like a fully controlled component?\n  // the issue here is that it doesn't clear the label?\n\n  return useGraph(graph => {\n    const hasChildren = node.childCount > 0\n    const selectedCount = graph.selectedNodes.size ?? 0\n\n    return (\n      <Box className={[classes.root, className].join(' ')}>\n        {graph.activeModes.includes('insert') && (\n          <LabelEditor\n            className={classes.labelEditor}\n            placeholder=\"Label\"\n            autoFocus\n            onValue={(value, event) => {\n              if (value) {\n                const child = graph.createChild(node, { label: value })\n\n                if (event?.ctrlKey) {\n                  graph.setCursorNode(child)\n                  navigate(makeUrl(`/node/${child.id}/`))\n                }\n              } else {\n                graph.toggleActiveMode('insert')\n              }\n            }}\n          />\n        )}\n\n        <Toolbar className={classes.toolbar}>\n          <IconButton\n            disabled\n            color={graph.activeModes.includes('edit') ? 'primary' : undefined}\n            onClick={() => graph.toggleActiveMode('edit')}\n          >\n            <SearchIcon />\n          </IconButton>\n\n          <IconButton\n            disabled={!hasChildren}\n            color={graph.activeModes.includes('edit') ? 'primary' : undefined}\n            onClick={() => graph.toggleActiveMode('edit')}\n          >\n            <EditIcon />\n          </IconButton>\n\n          <IconButton\n            color=\"primary\"\n            onClick={() => {\n              graph.setActiveMode('insert')\n            }}\n            className={classes.insertButton}\n          >\n            <AddIcon />\n          </IconButton>\n\n          <SelectButton\n            disabled={!(hasChildren || selectedCount > 0)}\n            node={node}\n            color={graph.activeModes.includes('select') ? 'primary' : undefined}\n            onClick={() => {\n              graph.toggleActiveMode('select')\n            }}\n          />\n\n          <IconButton\n            disabled\n            color={graph.activeModes.includes('edit') ? 'primary' : undefined}\n            onClick={() => graph.toggleActiveMode('edit')}\n          >\n            <TuneIcon />\n          </IconButton>\n\n          {false && (\n            <Button\n              disabled\n              startIcon={<GroupIcon />}\n              onClick={() => {\n                if (graph.activeModes.includes('share')) {\n                  graph.closePeerConnection()\n                } else {\n                  graph.offerPeerConnection(node)\n                }\n              }}\n              color={\n                graph.activeModes.includes('share') ? 'primary' : undefined\n              }\n            >\n              share\n            </Button>\n          )}\n        </Toolbar>\n      </Box>\n    )\n  })\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport { AppBar, Box, fade } from '@material-ui/core'\nimport { Instance } from 'mobx-state-tree'\nimport { createStyles, makeStyles, Theme } from '@material-ui/core/styles'\n\nimport { TitleBar } from 'common'\n\nimport { Node, useGraph, NodeActions } from 'graph'\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    root: {\n      textAlign: 'center',\n      position: 'relative',\n      paddingBottom: theme.spacing(9),\n    },\n\n    appBar: {\n      backdropFilter: 'blur(2px)',\n      background: `\n        linear-gradient(\n          to top,\n          ${fade(theme.palette.background.default, 0.9)},\n          ${fade(theme.palette.background.default, 1)} 90%\n        )`,\n    },\n\n    titleBar: {\n      background: 'unset',\n    },\n\n    children: {},\n\n    actions: {\n      zIndex: theme.zIndex.appBar,\n      position: 'fixed',\n      bottom: 0,\n      left: '50%',\n      transform: 'translateX(-50%)',\n      width: '100%',\n      [theme.breakpoints.up('sm')]: {\n        width: '600px',\n      },\n    },\n  }),\n)\n\ninterface LayoutProps {\n  node: Instance<typeof Node>\n  className?: string\n}\n\nexport const NodeLayout: React.FunctionComponent<LayoutProps> = ({\n  node,\n  className,\n  children,\n}) => {\n  const classes = useStyles()\n\n  return useGraph(graph => (\n    <Box className={[classes.root, className].join(' ')}>\n      <AppBar elevation={0} position=\"sticky\" className={classes.appBar}>\n        <TitleBar title={node.label} className={classes.titleBar} />\n      </AppBar>\n\n      <NodeActions\n        node={node}\n        className={[\n          classes.actions,\n          graph.activeModes.includes('insert') ? 'fade' : '',\n        ].join(' ')}\n      />\n\n      <Box\n        className={[\n          classes.children,\n          graph.activeModes.includes('insert') ? 'fade' : '',\n        ].join(' ')}\n      >\n        {children}\n      </Box>\n    </Box>\n  ))\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\n\nimport { NodeLayout, EdgeList, useGraph } from 'graph'\n\ninterface NodeViewerProps {\n  id?: string\n}\n\nexport const NodeViewer: React.FunctionComponent<NodeViewerProps> = ({ id }) =>\n  useGraph(graph => {\n    const lookup = graph.Node.get(id)\n    let node = graph.rootNode\n\n    if (lookup) {\n      node = lookup\n    }\n\n    return node ? (\n      <NodeLayout node={node}>\n        <EdgeList node={node} edgeTag=\"child\" outer />\n      </NodeLayout>\n    ) : null\n  })\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport * as reach from '@reach/router'\n\nimport { useGraph } from 'graph'\nimport { NodeViewer } from 'graph'\nimport { PeerConnector } from 'peer'\nimport { Settings } from 'common'\n\n// Necessary for now because this routing library is bad.\nexport function makeUrl(path = ''): string {\n  return process.env.PUBLIC_URL + path\n}\n\nexport type RouteProps<T = unknown> = {\n  component: React.FunctionComponent<T>\n} & reach.RouteComponentProps\n\nexport const Route: React.FunctionComponent<RouteProps> = ({\n  component: Component,\n  ...props\n}) => <Component {...props} />\n\nexport const Router: React.FunctionComponent = () =>\n  useGraph(graph =>\n    graph.rootNode ? (\n      <reach.Router basepath={process.env.PUBLIC_URL}>\n        <Route path=\"/\" component={NodeViewer} />\n        <Route path=\":type/:id\" component={NodeViewer} />\n        <Route path=\"peer/:id\" component={PeerConnector} />\n        <Route path=\"settings\" component={Settings} />\n      </reach.Router>\n    ) : null,\n  )\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport {\n  // https://github.com/mui-org/material-ui/issues/13394\n  // TODO Remove when Material UI v5 is out.\n  unstable_createMuiStrictModeTheme as createMuiTheme,\n  ThemeProvider as MuiThemeProvider,\n  fade,\n} from '@material-ui/core/styles'\nimport { useMediaQuery, CssBaseline, PaletteType } from '@material-ui/core'\n\nexport const useDarkMode = (): ReturnType<typeof useMediaQuery> =>\n  useMediaQuery('(prefers-color-scheme: dark)')\n\nexport const ThemeProvider: React.FunctionComponent = ({ children }) => {\n  const prefersDarkMode = useDarkMode()\n  const theme: ReturnType<typeof createMuiTheme> = React.useMemo(() => {\n    const palette = {\n      type: (prefersDarkMode ? 'dark' : 'light') as PaletteType,\n      primary: { main: '#FF2EA2' },\n      secondary: { main: '#FF8F00' },\n      background: {\n        default: prefersDarkMode ? '#000000' : '#ffffff',\n      },\n      text: {\n        primary: prefersDarkMode ? '#dddddd' : '#212121',\n        secondary: prefersDarkMode ? '#aaaaaa' : '#454545',\n      },\n    }\n\n    return createMuiTheme({\n      typography: {\n        fontSize: 16,\n\n        fontFamily: [\n          '-apple-system',\n          'system-ui',\n          'BlinkMacSystemFont',\n          '\"Segoe UI\"',\n          'Roboto',\n          '\"Helvetica Neue\"',\n          'Arial',\n          'sans-serif',\n        ].join(', '),\n      },\n\n      palette,\n\n      shape: {\n        borderRadius: 6,\n      },\n\n      props: {\n        MuiButton: {\n          disableElevation: true,\n        },\n\n        MuiButtonGroup: {\n          disableElevation: true,\n        },\n      },\n\n      overrides: {\n        MuiButtonBase: {\n          root: {\n            cursor: 'default',\n          },\n        },\n\n        MuiCssBaseline: {\n          '@global': {\n            '*::selection': {\n              backgroundColor: fade(palette.primary.main, 0.3),\n            },\n\n            html: {\n              userSelect: 'none',\n              overscrollBehavior: 'none',\n              '-webkit-touch-callout': 'none',\n              maxWidth: '600px',\n              margin: 'auto',\n              '&, & body': {\n                height: '100%',\n              },\n            },\n          },\n        },\n      },\n    })\n  }, [prefersDarkMode])\n\n  return (\n    <MuiThemeProvider theme={theme}>\n      <CssBaseline />\n      {children}\n    </MuiThemeProvider>\n  )\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport ReactDOM from 'react-dom'\nimport 'mobx-react-lite/batchingForReactDom'\n\nimport { StoreProvider } from './store'\nimport { ThemeProvider } from './theme'\nimport { Router } from './route'\n/* import * as serviceWorker from './serviceWorker' */\n\nReactDOM.render(\n  <React.StrictMode>\n    <StoreProvider>\n      <ThemeProvider>\n        <Router />\n      </ThemeProvider>\n    </StoreProvider>\n  </React.StrictMode>,\n  document.getElementById('root'),\n)\n\n/* serviceWorker.register() */\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport { AppBar, Box } from '@material-ui/core'\nimport { createStyles, makeStyles, Theme } from '@material-ui/core/styles'\n\nimport { TitleBar } from 'common'\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    root: {},\n    appBar: {},\n    actions: {\n      width: '100%',\n      color: theme.palette.text.secondary,\n      backgroundColor: theme.palette.background.default,\n      padding: theme.spacing(0, 2, 0, 2),\n    },\n    children: {},\n  }),\n)\n\ninterface LayoutProps {\n  title?: string\n  actions?: React.ReactElement\n  className?: string\n}\n\nexport const Layout: React.FunctionComponent<LayoutProps> = ({\n  title,\n  actions,\n  className,\n  children,\n}) => {\n  const classes = useStyles()\n  return (\n    <Box className={[classes.root, className].join(' ')}>\n      <AppBar elevation={0} position=\"sticky\" className={classes.appBar}>\n        <TitleBar title={title} />\n        {actions}\n      </AppBar>\n      <Box className={classes.children}>{children}</Box>\n    </Box>\n  )\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport { Typography, Toolbar, IconButton } from '@material-ui/core'\nimport ChevronLeftIcon from '@material-ui/icons/ChevronLeft'\nimport SettingsIcon from '@material-ui/icons/Settings'\nimport { createStyles, makeStyles, Theme } from '@material-ui/core/styles'\nimport { Link } from '@reach/router'\n\nimport { makeUrl } from 'route'\nimport { isRootPath } from 'common'\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    root: {\n      color: theme.palette.text.secondary,\n      backgroundColor: theme.palette.background.default,\n      padding: theme.spacing(0, 2, 0, 2),\n    },\n    backButton: {\n      cursor: 'pointer',\n      '&[disabled]': {\n        visibility: 'hidden',\n        pointerEvents: 'none',\n      },\n    },\n    hide: {\n      visibility: 'hidden',\n      mouseEvents: 'none',\n    },\n    settingsButton: {},\n    title: {\n      flexGrow: 1,\n      textAlign: 'center',\n      overflowX: 'hidden',\n      whiteSpace: 'nowrap',\n      textOverflow: 'ellipsis',\n      color: theme.palette.text.primary,\n    },\n  }),\n)\n\ninterface TitleBarProps {\n  title?: string\n  showBackButton?: boolean\n  showSettingsButton?: boolean\n  className?: string\n}\n\nexport const TitleBar: React.FunctionComponent<TitleBarProps> = ({\n  title,\n  showBackButton,\n  showSettingsButton,\n  className,\n  children,\n}) => {\n  const classes = useStyles()\n  const newlinePosition = title?.indexOf('\\n') ?? -1\n\n  return (\n    <Toolbar className={[classes.root, className].join(' ')}>\n      <IconButton\n        disabled={isRootPath()}\n        edge=\"start\"\n        aria-label=\"back\"\n        onClick={() => window.history.back()}\n        className={[\n          classes.backButton,\n          showBackButton ? '' : classes.hide,\n        ].join(' ')}\n      >\n        <ChevronLeftIcon />\n      </IconButton>\n\n      {title && (\n        <Typography variant=\"h6\" className={classes.title}>\n          {newlinePosition > 0 ? title.slice(0, title.indexOf('\\n')) : title}\n        </Typography>\n      )}\n\n      <IconButton\n        disabled\n        edge=\"end\"\n        component={Link}\n        to={makeUrl(`/settings`)}\n        aria-label=\"settings\"\n        className={[\n          classes.settingsButton,\n          showSettingsButton ? '' : classes.hide,\n        ].join(' ')}\n      >\n        {<SettingsIcon fontSize=\"small\" />}\n      </IconButton>\n    </Toolbar>\n  )\n}\n\nTitleBar.defaultProps = {\n  title: 'Exuo',\n  showBackButton: true,\n  showSettingsButton: false,\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport {\n  List,\n  ListItem,\n  ListItemIcon,\n  ListItemSecondaryAction,\n  ListItemText,\n  ListSubheader,\n  Switch,\n} from '@material-ui/core'\nimport PlaylistAddCheckIcon from '@material-ui/icons/PlaylistAddCheck'\nimport BorderAllIcon from '@material-ui/icons/BorderAll'\nimport AccountTreeIcon from '@material-ui/icons/AccountTree'\n\nimport { Layout } from 'common'\nimport { useGraph } from 'graph'\n\nexport const Settings: React.FunctionComponent = () => {\n  return useGraph(graph => (\n    <Layout>\n      <List subheader={<ListSubheader>Global</ListSubheader>}>\n        <ListItem>\n          <ListItemIcon>\n            <BorderAllIcon />\n          </ListItemIcon>\n          <ListItemText id=\"switch-list-label-dividers\" primary=\"Dividers\" />\n          <ListItemSecondaryAction>\n            <Switch\n              disabled\n              edge=\"end\"\n              inputProps={{\n                'aria-labelledby': 'switch-list-label-list-dividers',\n              }}\n            />\n          </ListItemSecondaryAction>\n        </ListItem>\n      </List>\n      <List subheader={<ListSubheader>Lists</ListSubheader>}>\n        <ListItem>\n          <ListItemIcon>\n            <PlaylistAddCheckIcon />\n          </ListItemIcon>\n          <ListItemText\n            id=\"switch-list-label-checkboxes\"\n            primary=\"Checkboxes\"\n          />\n          <ListItemSecondaryAction>\n            <Switch\n              checked={graph.listCheckboxSetting ?? false}\n              onChange={() => graph.toggleListCheckboxSetting()}\n              edge=\"end\"\n              inputProps={{\n                'aria-labelledby': 'switch-list-label-list-checkboxes',\n              }}\n            />\n          </ListItemSecondaryAction>\n        </ListItem>\n        <ListItem>\n          <ListItemIcon>\n            <BorderAllIcon />\n          </ListItemIcon>\n          <ListItemText id=\"switch-list-label-dividers\" primary=\"Dividers\" />\n          <ListItemSecondaryAction>\n            <Switch\n              disabled\n              edge=\"end\"\n              inputProps={{\n                'aria-labelledby': 'switch-list-label-list-dividers',\n              }}\n            />\n          </ListItemSecondaryAction>\n        </ListItem>\n        <ListItem>\n          <ListItemIcon>\n            <AccountTreeIcon />\n          </ListItemIcon>\n          <ListItemText\n            id=\"switch-list-label-bluetooth\"\n            primary=\"Show Extra Edge Types\"\n          />\n          <ListItemSecondaryAction>\n            <Switch\n              disabled\n              edge=\"end\"\n              inputProps={{ 'aria-labelledby': 'switch-list-label-bluetooth' }}\n            />\n          </ListItemSecondaryAction>\n        </ListItem>\n      </List>\n    </Layout>\n  ))\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport { makeUrl } from 'route'\n\nexport const isRootPath = (): boolean =>\n  window.location.pathname === makeUrl('/') ||\n  window.location.pathname === makeUrl()\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport {\n  Instance,\n  onPatch,\n  getSnapshot,\n  getMembers,\n  applySnapshot,\n  IAnyModelType,\n  IJsonPatch,\n  isStateTreeNode,\n} from 'mobx-state-tree'\nimport Dexie from 'dexie'\n\nexport async function persist(\n  instance: Instance<IAnyModelType>,\n): Promise<void> {\n  const db = new Dexie('default')\n  const tableNames = Object.keys(getMembers(instance).properties)\n  const tableConfig = Object.fromEntries(tableNames.map(name => [name, 'id']))\n\n  db.version(1).stores(tableConfig)\n\n  return Promise.all(\n    tableNames.map(name =>\n      db\n        .table(name)\n        .toArray()\n        .then(rows => [name, Object.fromEntries(rows.map(r => [r.id, r]))]),\n    ),\n  ).then(resolved => {\n    applySnapshot(instance, Object.fromEntries(resolved))\n\n    let buffer: Array<IJsonPatch> = []\n    let timeout: ReturnType<typeof setTimeout>\n\n    onPatch(instance, patch => {\n      buffer.push(patch)\n\n      if (timeout) {\n        clearTimeout(timeout)\n      }\n\n      timeout = setTimeout(() => {\n        buffer.forEach(patch => {\n          const [typeName, id, propName] = patch.path.split('/').slice(1)\n\n          if (patch.op === 'add') {\n            db.table(typeName).put(getSnapshot(instance[typeName].get(id)))\n          } else if (patch.op === 'replace' || patch.op === 'remove') {\n            if (propName) {\n              let propValue = instance[typeName].get(id)[propName]\n\n              if (isStateTreeNode(propValue)) {\n                propValue = getSnapshot(propValue)\n              }\n\n              db.table(typeName).update(id, {\n                [propName]: propValue,\n              })\n            } else {\n              db.table(typeName).delete(id)\n            }\n          } else {\n            throw Error(`Unknown patch op '${patch.op}'`)\n          }\n        })\n\n        buffer = []\n      }, 1000)\n    })\n  })\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport { Instance } from 'mobx-state-tree'\n\nimport { Graph } from 'graph'\n\nimport { Store } from './models/Store'\n\nconst store = Store.create({\n  graph: Graph.create(),\n})\n\nexport const storeContext = React.createContext<Instance<typeof Store>>(store)\n\nexport const StoreProvider: React.FunctionComponent = ({ children }) =>\n  React.createElement(storeContext.Provider, { value: store }, children)\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport { List, ListItem, ListItemText } from '@material-ui/core'\nimport { createStyles, makeStyles, Theme } from '@material-ui/core/styles'\nimport { getMembers, Instance, isStateTreeNode } from 'mobx-state-tree'\n\nimport { useGraph, Node } from 'graph'\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    root: {},\n    item: {},\n    itemText: {},\n  }),\n)\n\ninterface PropertyEditorProps {\n  node?: Instance<typeof Node> | string\n  propName?: string\n  minimal?: boolean\n}\n\nexport const PropertyEditor: React.FunctionComponent<PropertyEditorProps> = props => {\n  const classes = useStyles()\n\n  return useGraph(graph => {\n    let node = props.node\n    if (typeof node === 'string') {\n      node = graph.Node.get(props.node)\n    }\n\n    if (!isStateTreeNode(node)) {\n      return <></> // Loading\n    }\n\n    const members = getMembers(node)\n    const properties = Object.keys(members.properties)\n\n    const handleSubmit: React.EventHandler<React.SyntheticEvent> = () => {\n      console.log('submit')\n    }\n\n    return (\n      <form onSubmit={handleSubmit}>\n        <List className={classes.root}>\n          {properties.map(value => (\n            <ListItem dense button key={value} className={classes.item}>\n              <ListItemText\n                primary={value}\n                id={`list-label-${value}`}\n                className={classes.itemText}\n              />\n            </ListItem>\n          ))}\n        </List>\n      </form>\n    )\n  })\n}\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport { types } from 'mobx-state-tree'\n\nimport { Graph } from 'graph'\n\nexport const Store = types\n  .model('Store', {\n    graph: Graph,\n    location: types.optional(types.string, '/'),\n  })\n  .actions(self => ({\n    setLocation(path: string) {\n      self.location = path\n    },\n  }))\n","/*\n * Copyright © 2020 Ty Dira <ty@dira.dev>\n\n * This file is part of Exuo.\n\n * Exuo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n\n * Exuo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n\n * You should have received a copy of the GNU Affero General Public License\n * along with Exuo.  If not, see <https://www.gnu.org/licenses/>.\n */\n\nimport React from 'react'\nimport { Instance } from 'mobx-state-tree'\nimport { useObserver } from 'mobx-react-lite'\n\nimport { Store, storeContext } from 'store'\n\nexport function useStore<S>(selector: (s: Instance<typeof Store>) => S): S {\n  const store = React.useContext(storeContext)\n  if (store) {\n    return useObserver(() => selector(store))\n  } else {\n    throw Error('Cannot use store before setup')\n  }\n}\n"],"sourceRoot":""}